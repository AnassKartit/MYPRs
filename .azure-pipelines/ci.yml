# ============================================================
# CI Pipeline - PR Tracker Extension
# Runs on every push and PR to validate build, lint, and security
# ============================================================

trigger:
  branches:
    include:
      - main
      - develop
      - release/*

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: "ubuntu-latest"

variables:
  nodeVersion: "20.x"
  npmCacheFolder: $(Pipeline.Workspace)/.npm

stages:
  # ─────────────────────────────────────────────
  # Stage 1: Build & Validate
  # ─────────────────────────────────────────────
  - stage: Build
    displayName: "Build & Validate"
    jobs:
      - job: BuildAndLint
        displayName: "Build, Lint & Type Check"
        steps:
          - task: NodeTool@0
            displayName: "Install Node.js $(nodeVersion)"
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: "Cache npm packages"
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npmCacheFolder)

          - script: npm ci
            displayName: "Install dependencies (clean)"

          - script: npx tsc --noEmit
            displayName: "TypeScript type check"

          - script: npm run lint
            displayName: "ESLint (with security rules)"
            continueOnError: false

          - script: npm run build
            displayName: "Webpack production build"

          - publish: $(System.DefaultWorkingDirectory)/dist
            artifact: dist
            displayName: "Publish build artifacts"

  # ─────────────────────────────────────────────
  # Stage 2: Security Scanning
  # ─────────────────────────────────────────────
  - stage: Security
    displayName: "Security Scan"
    dependsOn: Build
    jobs:
      - job: AuditAndScan
        displayName: "Dependency Audit & SAST"
        steps:
          - task: NodeTool@0
            displayName: "Install Node.js $(nodeVersion)"
            inputs:
              versionSpec: $(nodeVersion)

          - script: npm ci
            displayName: "Install dependencies"

          - script: |
              echo "## npm audit results" > $(Build.ArtifactStagingDirectory)/audit-report.txt
              npm audit --production 2>&1 | tee -a $(Build.ArtifactStagingDirectory)/audit-report.txt
              echo ""
              echo "## Audit complete"
            displayName: "npm audit (production dependencies)"
            continueOnError: true

          - script: |
              npx audit-ci --config audit-ci.json 2>&1 || true
            displayName: "audit-ci threshold check"
            continueOnError: true

          - script: bash scripts/sast-check.sh
            displayName: "Static Application Security Testing (SAST)"
            continueOnError: false

          - publish: $(Build.ArtifactStagingDirectory)
            artifact: security-reports
            displayName: "Publish security reports"
            condition: always()

  # ─────────────────────────────────────────────
  # Stage 3: Package VSIX (validation only on PRs)
  # ─────────────────────────────────────────────
  - stage: Package
    displayName: "Package VSIX"
    dependsOn:
      - Build
      - Security
    condition: succeeded()
    jobs:
      - job: CreateVSIX
        displayName: "Create VSIX Package"
        steps:
          - task: NodeTool@0
            displayName: "Install Node.js $(nodeVersion)"
            inputs:
              versionSpec: $(nodeVersion)

          - script: npm ci
            displayName: "Install dependencies"

          - download: current
            artifact: dist
            displayName: "Download build artifacts"

          - script: |
              cp -r $(Pipeline.Workspace)/dist $(System.DefaultWorkingDirectory)/dist
            displayName: "Restore build output"

          - script: |
              npx tfx extension create \
                --manifest-globs vss-extension.json \
                --output-path $(Build.ArtifactStagingDirectory)/vsix
            displayName: "Create VSIX package"

          - script: |
              VSIX_FILE=$(ls $(Build.ArtifactStagingDirectory)/vsix/*.vsix)
              VSIX_SIZE=$(du -h "$VSIX_FILE" | cut -f1)
              echo "VSIX: $(basename $VSIX_FILE) ($VSIX_SIZE)"

              mkdir -p vsix-check
              unzip -q "$VSIX_FILE" -d vsix-check

              MISSING=0
              for REQUIRED in "extension.vsomanifest" "extension/dist/hub.js" "extension/dist/hub.html" "extension/static/icon.png"; do
                if [ ! -f "vsix-check/$REQUIRED" ]; then
                  echo "##vso[task.logissue type=error]Missing required file in VSIX: $REQUIRED"
                  MISSING=$((MISSING + 1))
                else
                  echo "  OK: $REQUIRED"
                fi
              done

              if [ $MISSING -gt 0 ]; then
                echo "##vso[task.logissue type=error]VSIX validation failed — $MISSING required file(s) missing"
                exit 1
              fi
              echo "VSIX validation passed"
              rm -rf vsix-check
            displayName: "Validate VSIX contents"

          - publish: $(Build.ArtifactStagingDirectory)/vsix
            artifact: vsix
            displayName: "Publish VSIX artifact"
