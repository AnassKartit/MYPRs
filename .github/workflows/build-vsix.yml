# ============================================================
# Build VSIX - Manual workflow to build & validate VSIX
# Use this to test packaging without creating a release
# ============================================================

name: Build VSIX

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version override (e.g. 1.2.0-beta.1) â€” leave empty for package.json version"
        required: false
        type: string

permissions:
  contents: read

env:
  NODE_VERSION: 20

jobs:
  build-vsix:
    name: Build & Validate VSIX
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: ESLint
        run: npm run lint

      - name: Security audit
        run: npm audit --production --audit-level=high
        continue-on-error: true

      - name: SAST checks
        run: bash scripts/sast-check.sh

      - name: Webpack production build
        run: npm run build

      - name: Set version
        id: version
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building VSIX version: $VERSION"

          node -e "
            const fs = require('fs');
            const m = JSON.parse(fs.readFileSync('vss-extension.json', 'utf8'));
            m.version = '$VERSION';
            fs.writeFileSync('vss-extension.json', JSON.stringify(m, null, 2));
          "

      - name: Create VSIX package
        run: |
          mkdir -p vsix
          npx tfx extension create \
            --manifest-globs vss-extension.json \
            --output-path ./vsix

      - name: Validate VSIX contents
        run: |
          VSIX_FILE=$(ls vsix/*.vsix)
          VSIX_SIZE=$(du -h "$VSIX_FILE" | cut -f1)
          echo "VSIX: $(basename $VSIX_FILE) ($VSIX_SIZE)"

          mkdir -p vsix-check
          unzip -q "$VSIX_FILE" -d vsix-check

          echo "Package contents:"
          find vsix-check -type f | sort | head -50

          MISSING=0
          for REQUIRED in "extension.vsomanifest" "extension/dist/hub.js" "extension/dist/hub.html" "extension/static/icon.png"; do
            if [ ! -f "vsix-check/$REQUIRED" ]; then
              echo "::error::Missing: $REQUIRED"
              MISSING=$((MISSING + 1))
            else
              echo "  OK: $REQUIRED"
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "::error::VSIX validation failed"
            exit 1
          fi
          echo "VSIX validation passed"
          rm -rf vsix-check

      - uses: actions/upload-artifact@v4
        with:
          name: vsix-${{ steps.version.outputs.version }}
          path: vsix/*.vsix
          retention-days: 30
